<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estrat√©gico CX (V10.3 - M√∫ltiplas Vis√µes)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background-color: #1a1a1a; color: #f0f0f0;
        }
        /* Container principal */
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; }
        header { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        h1, h2, h3 { color: #4a90e2; }
        
        /* Grade 2x2 para os 4 filtros */
        .view-controls {
            display: grid; 
            grid-template-columns: 1fr 1fr; /* Grade 2x2 */
            gap: 20px; margin-bottom: 20px;
            padding: 15px; background: #2a2a2a; border-radius: 8px;
        }

        /* Em telas menores (m√≥veis), for√ßa uma coluna √∫nica */
        @media (max-width: 768px) {
          .view-controls {
              grid-template-columns: 1fr;
          }
          .charts-grid {
              grid-template-columns: 1fr !important; /* For√ßa 1 coluna no gr√°fico */
          }
          .audit-grid {
              grid-template-columns: 1fr !important; /* For√ßa 1 coluna nos detalhes */
          }
        }
        
        label { font-weight: 600; display: block; margin-bottom: 5px; color: #bbb; }
        select {
            width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #555;
            font-size: 16px; background-color: #333; color: #f0f0f0;
        }
        .view-container { display: none; }
        #view-global { border-top: 1px solid #333; padding-top: 20px; }
        .metricas-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;
        }
        .metrica-card {
            background: #2a2a2a; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); text-align: center;
        }
        .metrica-card h3 { margin: 0 0 10px 0; font-size: 1.1em; color: #8cb4e1; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .metrica-card .valor { font-size: 2.5em; font-weight: 700; color: #fff; }
        .metrica-card .sub { font-size: 0.9em; color: #999; }
        .charts-grid {
            display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 30px;
        }
        /* NOVO: Estilo para grids de 1 coluna */
        .charts-grid-single {
             display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 30px;
        }
        
        .chart-container {
            background: #2a2a2a; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .chart-container h3 { text-align: center; margin-top: 0; }
        #view-especifica {
            background: #2a2a2a; padding: 25px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); margin-top: 20px;
        }
        .audit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .audit-section h3 { border-bottom: 1px solid #4a90e2; padding-bottom: 5px; }
        .audit-section p {
            margin: 10px 0; padding-bottom: 10px; border-bottom: 1px solid #333; line-height: 1.6;
        }
        .audit-section p strong { color: #8cb4e1; min-width: 150px; display: inline-block; }
        .audit-section p span { color: #f0f0f0; }
        .tooltip {
            cursor: help; border: 1px solid #777; border-radius: 50%; width: 16px; height: 16px;
            display: inline-block; text-align: center; font-size: 12px; line-height: 16px;
            color: #777; margin-left: 8px; position: relative; top: -1px;
        }
        .tooltip:hover { background: #777; color: #1a1a1a; }
        .loading { text-align: center; font-size: 1.2em; color: #777; padding: 40px 0; }
        .status-banner {
            display: none; padding: 16px 20px; border-radius: 6px; margin-bottom: 20px;
            border-left: 4px solid transparent; background: rgba(74, 144, 226, 0.12);
        }
        .status-banner.info { border-color: #4a90e2; color: #d0e2ff; }
        .status-banner.success { border-color: #417505; background: rgba(65, 117, 5, 0.15); color: #d8f0c8; }
        .status-banner.warning { border-color: #f5a623; background: rgba(245, 166, 35, 0.18); color: #ffe2b5; }
        .status-banner.error { border-color: #d0021b; background: rgba(208, 2, 27, 0.15); color: #ffd4d4; }
        .status-banner.show { display: block; }
        .status-banner strong { display: block; margin-bottom: 6px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Dashboard Estrat√©gico CX (V10.3)</h1>
        </header>

        <div id="status-banner" class="status-banner"></div>

            <div class="view-controls" id="controles-principais">
            <div>
                <label for="grupo-select">1. Selecione o Grupo:</label>
                <select id="grupo-select" onchange="atualizarFiltrosGrupo()">
                    <option value="global" selected>Vis√£o Global (Todos Grupos)</option>
                </select>
            </div>
            <div>
                <label for="produto-select">2. Produto (Filtro Opcional):</label>
                <select id="produto-select" onchange="atualizarFiltrosProduto()" disabled>
                    <option value="global">Todos Produtos (Grupo)</option>
                </select>
            </div>
            <div>
                <label for="aba-select">3. Selecione o Funcion√°rio (Aba):</label>
                <select id="aba-select" onchange="carregarAuditorias()" disabled>
                    <option value="global">Todos Funcion√°rios (Grupo)</option>
                </select>
            </div>
            <div>
                <label for="audit-select">4. Selecione a Auditoria:</label>
                <select id="audit-select" onchange="renderizarDashboard()" disabled>
                    <option value="global">Vis√£o Geral (Funcion√°rio)</option>
                </select>
            </div>
        </div>
                
        <div id="loading" class="loading">Carregando dados...</div>

        <div id="view-global" class="view-container">
            <h2 id="global-titulo">Vis√£o Global</h2>
            <div class="metricas-grid" id="global-metricas-grid"></div>
            
            <div class="charts-grid" id="charts-grid"> 
                <div class="chart-container">
                    <h3>Tipo de Chamada</h3>
                    <canvas id="chart-global-tipo"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Desempenho por Pilar de CX</h3>
                    <canvas id="chart-global-pilares"></canvas>
                </div>
            </div>

            <div class="charts-grid-single" id="charts-grid-tendencia">
                <div class="chart-container">
                    <h3>Evolu√ß√£o da Conformidade (Mensal)</h3>
                    <canvas id="chart-global-tendencia"></canvas>
                </div>
            </div>

            <div class="charts-grid-single" id="charts-grid-ranking" style="display: none;">
                <div class="chart-container">
                    <h3>Ranking de Desempenho (Agentes do Grupo)</h3>
                    <canvas id="chart-global-ranking"></canvas>
                </div>
            </div>

            <div class="charts-grid-single" id="charts-grid-correlacao" style="display: none;">
                <div class="chart-container">
                    <h3>Correla√ß√£o: Dura√ß√£o (seg) vs Conformidade (%)</h3>
                    <canvas id="chart-global-correlacao"></canvas>
                </div>
            </div>

        </div>

        <div id="view-especifica" class="view-container">
            <h2 id="especifica-titulo">Detalhes da Auditoria (ID: 1)</h2>
            <div class="audit-grid">
                <div class="audit-section" id="especifica-cabecalho"></div>
                <div class="audit-section" id="especifica-perguntas"></div>
            </div>
            <div class="audit-section" id="especifica-pilares"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const WORKER_URL = "https://super-union-6352.sensedata-dash.workers.dev";
        const VALOR_CONFORME = "üü¢ Conforme"; 
        const FETCH_TIMEOUT_MS = 12000;
        const MAX_FETCH_RETRIES = 3;
        const RETRY_DELAY_BASE_MS = 700;
        const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6 horas
        const STORAGE_KEYS = {
            abas: "cx-dashboard-cache-abas",
            auditsPrefix: "cx-dashboard-cache-audits"
        };
        const PILARES_MAP = [
            { id_nome: "pilar1_nome", id_conf: "pilar1_conf", id_obs: "pilar1_obs", id_leg: "legenda1" },
            { id_nome: "pilar2_nome", id_conf: "pilar2_conf", id_obs: "pilar2_obs", id_leg: "legenda2" },
            { id_nome: "pilar3_nome", id_conf: "pilar3_conf", id_obs: "pilar3_obs", id_leg: "legenda3" },
            { id_nome: "pilar4_nome", id_conf: "pilar4_conf", id_obs: "pilar4_obs", id_leg: "legenda4" },
            { id_nome: "pilar5_nome", id_conf: "pilar5_conf", id_obs: "pilar5_obs", id_leg: "legenda5" },
            { id_nome: "pilar6_nome", id_conf: "pilar6_conf", id_obs: "pilar6_obs", id_leg: "legenda6" }
        ];
        const diagnostics = { warnings: [] };
        // --- FIM DA CONFIGURA√á√ÉO ---

        let state = {
            todasAuditorias: [], 
            mapaGrupos: new Map(), // Mapa: { grupo: ["Aba1", "Aba2"] }
            grupos: [] // Lista de Grupos (ex: Solidworks, Hexagon)
        };
        
        let chartInstances = {};
        const $ = (id) => document.getElementById(id);

        const statusBanner = (() => {
            const banner = () => $("status-banner");
            function resetClass(el) {
                el.className = "status-banner";
            }
            return {
                clear() {
                    const el = banner();
                    if (!el) return;
                    resetClass(el);
                    el.innerHTML = "";
                },
                show(type, message, details) {
                    const el = banner();
                    if (!el) return;
                    resetClass(el);
                    el.classList.add(type, "show");
                    const detailHtml = details ? `<div>${details}</div>` : "";
                    el.innerHTML = `<strong>${message}</strong>${detailHtml}`;
                },
                append(type, message) {
                    const el = banner();
                    if (!el) return;
                    el.classList.add(type, "show");
                    const line = document.createElement("div");
                    line.textContent = message;
                    el.appendChild(line);
                }
            };
        })();

        const storage = {
            get(key) {
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw) return null;
                    const parsed = JSON.parse(raw);
                    if (!parsed || typeof parsed !== "object") return null;
                    if (parsed.timestamp && Date.now() - parsed.timestamp > CACHE_TTL_MS) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    return parsed.value ?? null;
                } catch (error) {
                    console.warn("[Dashboard] Falha ao ler cache", error);
                    return null;
                }
            },
            set(key, value) {
                try {
                    const payload = JSON.stringify({ timestamp: Date.now(), value });
                    localStorage.setItem(key, payload);
                } catch (error) {
                    console.warn("[Dashboard] Falha ao salvar cache", error);
                }
            }
        };

        // --- 1. CARREGAMENTO GLOBAL (AO INICIAR) ---
        async function carregarTudo() {
            statusBanner.clear();
            diagnostics.warnings = [];
            const loadingEl = $("loading");
            if (loadingEl) {
                loadingEl.style.display = "block";
                loadingEl.innerText = "Carregando dados de todas as auditorias...";
            }
            
            try {
                const cacheBust = `?cb=${Date.now()}`;

                const abasResult = await fetchJsonWithRetry(`${WORKER_URL}/get-abas${cacheBust}`, {
                    cacheKey: STORAGE_KEYS.abas,
                    transform: sanitizeAbas
                });

                const abasGrupos = abasResult.data;
                if (!Array.isArray(abasGrupos) || abasGrupos.length === 0) {
                    throw new Error("Nenhuma aba retornada pelo servi√ßo.");
                }

                state.mapaGrupos = new Map();
                abasGrupos.forEach(item => {
                    if (!state.mapaGrupos.has(item.grupoNormalizado)) {
                        state.mapaGrupos.set(item.grupoNormalizado, []);
                    }
                    state.mapaGrupos.get(item.grupoNormalizado).push(item.aba);
                });
                state.mapaGrupos.forEach((abas, key, map) => {
                    const unicos = Array.from(new Set(abas)).sort();
                    map.set(key, unicos);
                });

                const uniqueCombos = deduplicateAbas(abasGrupos);

                const auditoriasResultados = await Promise.allSettled(
                    uniqueCombos.map(item => carregarAuditoriasPorCombo(item))
                );

                const todasAuditorias = [];
                const cacheMensagens = [];
                const falhasMensagens = [];

                auditoriasResultados.forEach((resultado, index) => {
                    const contexto = uniqueCombos[index];
                    if (resultado.status === "fulfilled") {
                        const payload = resultado.value;
                        todasAuditorias.push(...payload.data);
                        if (payload.source === "cache") {
                            cacheMensagens.push(`Dados recuperados do cache: ${contexto.aba} (${contexto.produtoOriginal})`);
                        }
                        if (payload.warnings?.length) {
                            payload.warnings.forEach(msg => reportWarning(msg));
                        }
                    } else {
                        const motivo = resultado.reason?.message || "Motivo n√£o informado";
                        falhasMensagens.push(`${contexto.aba} (${contexto.produtoOriginal}) - ${motivo}`);
                        reportWarning(`Falha ao carregar auditorias para ${contexto.aba} (${contexto.produtoOriginal})`, motivo);
                    }
                });

                if (!todasAuditorias.length) {
                    throw new Error("N√£o foi poss√≠vel carregar nenhuma auditoria (rede e cache indispon√≠veis).");
                }

                const auditoriasDeduplicadas = deduplicateAuditorias(todasAuditorias);
                state.todasAuditorias = auditoriasDeduplicadas;
                
                populateGrupoFilter();
                renderizarDashboard();
                
                if (loadingEl) {
                    loadingEl.style.display = "none";
                }
                $("view-global").style.display = "block"; 

                let bannerTipo = "success";
                let bannerTitulo = "Dados atualizados com sucesso.";
                let bannerDetalhe = "";

                if (falhasMensagens.length) {
                    bannerTipo = "warning";
                    bannerTitulo = "Dados carregados parcialmente.";
                    bannerDetalhe = `${falhasMensagens.length} fonte(s) n√£o responderam.`;
                } else if (cacheMensagens.length || abasResult.source === "cache") {
                    bannerTipo = "warning";
                    bannerTitulo = "Dados carregados a partir do cache.";
                    bannerDetalhe = "Verifique conectividade com o Worker para atualizar as informa√ß√µes.";
                }

                statusBanner.show(bannerTipo, bannerTitulo, bannerDetalhe);

                if (abasResult.source === "cache") {
                    statusBanner.append("warning", "Lista de abas servida do cache local.");
                }
                cacheMensagens.forEach(msg => statusBanner.append("warning", msg));
                falhasMensagens.forEach(msg => statusBanner.append(bannerTipo === "error" ? "error" : "warning", `Falha: ${msg}`));

                if (diagnostics.warnings.length) {
                    const uniqueWarnings = Array.from(new Set(diagnostics.warnings));
                    uniqueWarnings.forEach(msg => statusBanner.append("warning", msg));
                }

            } catch (error) {
                console.error(error);
                if (loadingEl) {
                    loadingEl.innerText = "Erro fatal ao carregar dados globais. Verifique o Worker.";
                }
                statusBanner.show("error", "N√£o foi poss√≠vel carregar o dashboard.", error.message || "Erro desconhecido.");
            }
        }

        // --- 2. FUN√á√ïES DE FILTRO E ROTEAMENTO (Dropdowns) ---
        
        // (Dropdown 1) Popula Grupos
        function populateGrupoFilter() {
            state.grupos = [...state.mapaGrupos.keys()].sort();
            const selectGrupo = $("grupo-select");
            selectGrupo.innerHTML = '<option value="global">Vis√£o Global (Todos Grupos)</option>';
            
            state.grupos.forEach(grupo => {
                const nome = (grupo === null) ? "(N√£o Preenchido)" : grupo;
                const valor = (grupo === null) ? "null" : grupo;
                selectGrupo.innerHTML += `<option value="${valor}">${nome}</option>`;
            });
        }
        
        // (Chamado pelo Dropdown 1)
        // Popula D2 (Produtos) E D3 (Funcion√°rios)
        function atualizarFiltrosGrupo() {
            const grupo = $("grupo-select").value;
            populateProdutos(grupo);
            populateFuncionarios(grupo, "global"); // Popula funcion√°rios baseado APENAS no grupo
            
            carregarAuditorias(); // Apenas reseta o D4
        }
        
        // (Chamado pelo Dropdown 2)
        // RE-FILTRA D3 (Funcion√°rios)
        function atualizarFiltrosProduto() {
            const grupo = $("grupo-select").value;
            const produto = $("produto-select").value;
            populateFuncionarios(grupo, produto); // RE-popula funcion√°rios com o filtro do produto
            
            carregarAuditorias(); // Apenas reseta o D4
        }
        
        // (Helper) Popula D2 - Produtos
        function populateProdutos(grupo) {
            const selectProduto = $("produto-select");
            
            if (grupo === "global") {
                selectProduto.innerHTML = '<option value="global">Todos Produtos (Grupo)</option>';
                selectProduto.disabled = true;
            } else {
                selectProduto.innerHTML = '<option value="global">Todos Produtos (Grupo)</option>';
                const grupoFiltrar = (grupo === "null") ? null : grupo;
                const auditsDoGrupo = state.todasAuditorias.filter(a => a.produto === grupoFiltrar);
                const produtosInternos = [...new Set(auditsDoGrupo.map(a => a.produto_interno))].sort();
                
                produtosInternos.forEach(produto => {
                    const nome = (produto === null) ? "(N√£o Preenchido/N/A)" : produto;
                    const valor = (produto === null) ? "null" : produto;
                    selectProduto.innerHTML += `<option value="${valor}">${nome}</option>`;
                });
                selectProduto.disabled = false;
            }
        }
        
        // (Helper) Popula D3 - Funcion√°rios
        function populateFuncionarios(grupo, produto) {
            const selectAba = $("aba-select");

            if (grupo === "global") {
                selectAba.innerHTML = '<option value="global">Todos Funcion√°rios (Grupo)</option>';
                selectAba.disabled = true;
                return; // Sai da fun√ß√£o
            }
            
            // Se um grupo √© selecionado, habilita e popula
            selectAba.disabled = false;
            const grupoFiltrar = (grupo === "null") ? null : grupo;
            let auditsFiltradas = state.todasAuditorias.filter(a => a.produto === grupoFiltrar);

            // Se um produto TAMB√âM for selecionado (filtro opcional)
            if (produto !== "global") {
                const produtoFiltrar = (produto === "null") ? null : produto;
                auditsFiltradas = auditsFiltradas.filter(a => a.produto_interno === produtoFiltrar);
                selectAba.innerHTML = '<option value="global">Todos Funcion√°rios (Produto)</option>';
            } else {
                selectAba.innerHTML = '<option value="global">Todos Funcion√°rios (Grupo)</option>';
            }

            const abas = [...new Set(auditsFiltradas.map(a => a.aba))].sort();
            abas.forEach(aba => {
                selectAba.innerHTML += `<option value="${aba}">${aba}</option>`;
            });
        }

        // (Chamado pelo Dropdown 3)
        // Popula D4 - Auditorias
        function carregarAuditorias() {
            const grupo = $("grupo-select").value;
            const produto = $("produto-select").value;
            const aba = $("aba-select").value;
            const selectAudit = $("audit-select");

            if (aba === "global") {
                selectAudit.innerHTML = '<option value="global">Vis√£o Geral</option>';
                selectAudit.disabled = true;
            } else {
                selectAudit.innerHTML = '<option value="global">Vis√£o Geral (Funcion√°rio)</option>';
                selectAudit.disabled = false;
                
                const grupoFiltrar = (grupo === "null") ? null : grupo;
                let auditsDoFuncionario = state.todasAuditorias.filter(a => 
                    a.produto === grupoFiltrar && 
                    a.aba === aba
                );
                
                // Filtra pelo produto se ele estiver selecionado
                if (produto !== "global") {
                    const produtoFiltrar = (produto === "null") ? null : produto;
                    auditsDoFuncionario = auditsDoFuncionario.filter(a => a.produto_interno === produtoFiltrar);
                }
                
                auditsDoFuncionario.forEach(audit => {
                    const titulo = `ID ${audit.id} (T√©c: ${audit.tecnico || "N/A"})`;
                    selectAudit.innerHTML += `<option value="${audit.id}">${titulo}</option>`;
                });
            }
            
            // Renderiza o dashboard com a sele√ß√£o atual
            renderizarDashboard();
        }


        // ROTEADOR PRINCIPAL - Decide o que mostrar
        function renderizarDashboard() {
            const grupo = $("grupo-select").value;
            const produto = $("produto-select").value;
            const aba = $("aba-select").value;
            const auditId = $("audit-select").value;
            
            destroyCharts();
            $("view-global").style.display = "none";
            $("view-especifica").style.display = "none";
            
            let dadosFiltrados = state.todasAuditorias;
            const grupoFiltrar = (grupo === "null") ? null : grupo;
            const produtoFiltrar = (produto === "null") ? null : produto;
            
            if (auditId !== "global") {
                // N√çVEL 4: Vis√£o Espec√≠fica (ID)
                const audit = state.todasAuditorias.find(a => 
                    a.id == auditId && 
                    a.aba === aba && 
                    (produto === "global" || a.produto_interno === produtoFiltrar) &&
                    a.produto === grupoFiltrar
                );
                $("view-especifica").style.display = "block";
                renderizarVisaoEspecificaDetalhes(audit);
                return; // Sai da fun√ß√£o
            } 
            
            // Se n√£o for vis√£o espec√≠fica, √© vis√£o GERAL
            $("view-global").style.display = "block";
            
            if (aba !== "global") {
                // N√çVEL 3: Vis√£o por Funcion√°rio
                dadosFiltrados = state.todasAuditorias.filter(a => a.produto === grupoFiltrar && a.aba === aba);
                if (produto !== "global") {
                    dadosFiltrados = dadosFiltrados.filter(a => a.produto_interno === produtoFiltrar);
                }
                $("global-titulo").innerText = `Vis√£o (Funcion√°rio: ${aba} | ${grupo})`;
            
            } else if (produto !== "global") {
                // N√çVEL 2: Vis√£o por Produto
                dadosFiltrados = state.todasAuditorias.filter(a => 
                    a.produto === grupoFiltrar && 
                    a.produto_interno === produtoFiltrar
                );
                $("global-titulo").innerText = `Vis√£o (Produto: ${produto} | ${grupo})`;
            
            } else if (grupo !== "global") {
                // N√çVEL 1: Vis√£o por Grupo
                dadosFiltrados = state.todasAuditorias.filter(a => a.produto === grupoFiltrar);
                $("global-titulo").innerText = `Vis√£o Geral (Grupo: ${grupo})`;
                
            } else {
                // N√çVEL 0: Vis√£o Global (Todos Grupos)
                dadosFiltrados = state.todasAuditorias;
                $("global-titulo").innerText = `Vis√£o Global (Todos Grupos)`;
           }
            
            // ATUALIZADO: Passa os filtros 'grupo' e 'aba' para a fun√ß√£o de renderiza√ß√£o
            renderizarVisaoGeral(dadosFiltrados, grupo, aba);
        }

        // --- 4. RENDERIZAR VIS√ÉO GERAL (KPIs e Gr√°ficos) ---
        // ATUALIZADO: Recebe 'grupoSelecionado' e 'abaSelecionada'
        function renderizarVisaoGeral(audits, grupoSelecionado, abaSelecionada) { 
            const grid = $("global-metricas-grid");
            const chartGrid = $("charts-grid");
            
            destroyCharts(); // Garante que todos os gr√°ficos (incluindo os novos) sejam limpos

            if (audits.length === 0) {
                grid.innerHTML = "<p>Nenhuma auditoria encontrada para os filtros selecionados.</p>";
                chartGrid.style.display = "none"; 
                // Esconde os novos gr√°ficos tamb√©m
                $("charts-grid-tendencia").style.display = "none";
                $("charts-grid-ranking").style.display = "none";
                $("charts-grid-correlacao").style.display = "none";
                return;
            }

            chartGrid.style.display = "grid"; 
            $("charts-grid-tendencia").style.display = "grid"; // Mostra o grid de tend√™ncia
            // Os outros grids (ranking, correla√ß√£o) s√£o controlados por suas pr√≥prias fun√ß√µes

            // --- C√°lculos Estrat√©gicos ---
            let totalPilaresAvaliados = 0, totalPilaresConformes = 0, totalDuracaoSegundos = 0,
                totalTransferencias = 0, chamadasAtivo = 0, chamadasReceptivo = 0;
            let pilarStats = {};
            PILARES_MAP.forEach(pilar => pilarStats[pilar.id_conf] = { total: 0, conforme: 0 });

            audits.forEach(audit => {
                totalDuracaoSegundos += parseDuration(audit.duracao);
                if (audit.transferencia && (audit.transferencia.toLowerCase() === "sim" || audit.transferencia.toLowerCase() === "s")) totalTransferencias++;
                if (audit.contato === 'Ativo') chamadasAtivo++;
                if (audit.contato === 'Receptivo') chamadasReceptivo++;
                
                PILARES_MAP.forEach(pilar => { 
                    const valorConf = audit[pilar.id_conf]; 
                    if (valorConf !== null) {
                        pilarStats[pilar.id_conf].total++;
                        totalPilaresAvaliados++;
                        if (valorConf === VALOR_CONFORME) {
                            pilarStats[pilar.id_conf].conforme++;
                            totalPilaresConformes++;
                        }
                    }
                });
            });

            // --- Renderizar os 4 KPIs ---
            let html = "";
            const totalAuditorias = audits.length;

            html += `<div class="metrica-card"><h3>Total de Auditorias</h3><div class="valor">${totalAuditorias}</div></div>`;
            
            const percGeral = (totalPilaresAvaliados === 0) ? 0 : (totalPilaresConformes / totalPilaresAvaliados) * 100;
            html += `<div class="metrica-card"><h3>Conformidade Geral</h3><div class="valor">${percGeral.toFixed(0)}%</div><div class="sub">${totalPilaresConformes} de ${totalPilaresAvaliados}</div></div>`;
            
            const avgSegundos = (totalAuditorias === 0) ? 0 : (totalDuracaoSegundos / totalAuditorias);
            const tmlString = new Date(avgSegundos * 1000).toISOString().substr(14, 5);
            html += `<div class="metrica-card"><h3>Tempo M√©dio (TML)</h3><div class="valor">${tmlString}</div></div>`;

            const percTransfer = (totalAuditorias === 0) ? 0 : (totalTransferencias / totalAuditorias) * 100;
            html += `<div class="metrica-card"><h3>Transfer√™ncias</h3><div class="valor">${percTransfer.toFixed(0)}%</div><div class="sub">${totalTransferencias} de ${totalAuditorias}</div></div>`;

            grid.innerHTML = html;
            
            // --- Renderizar os Gr√°ficos Globais (Originais) ---
            renderChart('chart-global-tipo', 'doughnut', {
                labels: ['Receptivo', 'Ativo'],
                datasets: [{ data: [chamadasReceptivo, chamadasAtivo], backgroundColor: ['#4a90e2', '#50e3c2'], borderColor: '#2a2a2a' }]
            }, { responsive: true, maintainAspectRatio: false, legend: { labels: { fontColor: '#f0f0f0' }} });

            const firstAudit = audits[0] || {}; 
            const pilarLabels = PILARES_MAP.map(pilar => firstAudit[pilar.id_nome] || pilar.id_conf);
           const pilarData = PILARES_MAP.map(pilar => { 
                const stats = pilarStats[pilar.id_conf];
                return (stats.total === 0) ? 0 : (stats.conforme / stats.total) * 100;
            });

            renderChart('chart-global-pilares', 'horizontalBar', {
                labels: pilarLabels,
                datasets: [{ label: 'Conformidade (%)', data: pilarData, backgroundColor: '#4a90e2' }]
            }, {
                responsive: true, legend: { display: false },
                scales: {
                    xAxes: [{ ticks: { beginAtZero: true, max: 100, fontColor: '#f0f0f0' }, gridLines: { color: '#444' } }],
                    yAxes: [{ ticks: { fontColor: '#f0f0f0' }, gridLines: { display: false } }]
                }
            });

            // --- NOVO: CHAMADA PARA OS NOVOS GR√ÅFICOS ---
            renderizarGraficoTendencia(audits);
            renderizarGraficoRanking(audits, grupoSelecionado, abaSelecionada);
            renderizarGraficoCorrelacao(audits);
        }

        // --- 5. RENDERIZAR VIS√ÉO ESPEC√çFICA (Drill-down) ---
        function renderizarVisaoEspecificaDetalhes(audit) {
            if (!audit) {
                $("view-especifica").innerHTML = "<h2>Erro: Auditoria n√£o encontrada.</h2>";
                return;
            }
            $("especifica-titulo").innerText = `Detalhes da Auditoria (ID: ${audit.id})`;
            
            $("especifica-cabecalho").innerHTML = `
                <h3>Cabe√ßalho da Auditoria</h3>
                <p><strong>T√©cnico:</strong> <span>${audit.tecnico || "N/A"}</span></p>
                <p><strong>Auditor:</strong> <span>${audit.responsavel || "N/A"}</span></p>
                <p><strong>Data Auditoria:</strong> <span>${audit.data_auditoria || "N/A"}</span></p>
                <p><strong>ID Liga√ß√£o:</strong> <span>${audit.identificacao || "N/A"}</span></p>
                <p><strong>Data Liga√ß√£o:</strong> <span>${audit.data_hora || "N/A"}</span></p>
                <p><strong>Dura√ß√£o:</strong> <span>${audit.duracao || "N/A"}</span></p>
                <p><strong>Cliente/C√≥digo:</strong> <span>${audit.cliente_codigo || "N/A"}</span></p>
                <p><strong>Contato:</strong> <span>${audit.contato || "N/A"}</span></p>
                <p><strong>Grupo:</strong> <span>${audit.produto || "N/A"}</span></p>
                <p><strong>Produto:</strong> <span>${audit.produto_interno || "N/A"}</span></p>
                <p><strong>Motivo:</strong> <span>${audit.motivo || "N/A"}</span></p>
                <p><strong>Transfer√™ncia:</strong> <span>${audit.transferencia || "N/A"}</span></p>
            `;
            $("especifica-perguntas").innerHTML = `
                <h3>Perguntas Iniciais</h3>
                <p><strong>Apresentou?:</strong> <span>${audit.q1_apresentou || "N/A"}</span></p>
                <p><strong>Avisou Pausa?:</strong> <span>${audit.q2_avisou || "N/A"}</span></p>
                <p><strong>Verificou?:</strong> <span>${audit.q3_verificou || "N/A"}</span></p>
            `;
            let pilaresHtml = `<h3>Pilares de CX</h3>`;
            PILARES_MAP.forEach(pilar => {
                const pilarNome = audit[pilar.id_nome] || "(Pilar n√£o nomeado)";
               const pilarConf = audit[pilar.id_conf];
                const pilarObs = audit[pilar.id_obs];
                const legendaTexto = audit[pilar.id_leg] || "Legenda n√£o encontrada.";
                
                pilaresHtml += `
                    <p>
                        <strong>
                            ${pilarNome}
                            <span class="tooltip" title="${legendaTexto}">?</span>
                        </strong> 
                        <span>${pilarConf || "N/A"}</span>
                        <br>
                        <span style="color: #999; font-style: italic;">Obs: ${pilarObs || "Sem observa√ß√µes."}</span>
                    </p>
                `;
            });
            $("especifica-pilares").innerHTML = pilaresHtml;
       }


        // --- 6. FUN√á√ïES AUXILIARES E NOVOS GR√ÅFICOS ---

        async function carregarAuditoriasPorCombo(combo) {
            const url = `${WORKER_URL}/get-audits?produto=${encodeURIComponent(combo.produtoOriginal)}&aba=${encodeURIComponent(combo.abaOriginal)}&cb=${Date.now()}`;
            const cacheKey = `${STORAGE_KEYS.auditsPrefix}:${encodeURIComponent(combo.produtoOriginal.toLowerCase())}:${encodeURIComponent(combo.abaOriginal.toLowerCase())}`;
            return fetchJsonWithRetry(url, {
                cacheKey,
                transform: data => sanitizeAudits(data, combo)
            });
        }

        async function fetchJsonWithRetry(url, { cacheKey, transform } = {}) {
            const warnings = [];
            let attempt = 0;
            let lastError = null;

            while (attempt < MAX_FETCH_RETRIES) {
                attempt++;
                try {
                    const response = await fetchWithTimeout(url, {}, FETCH_TIMEOUT_MS);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const rawData = await response.json();
                    const data = transform ? transform(rawData) : rawData;
                    if (cacheKey) {
                        storage.set(cacheKey, data);
                    }
                    if (attempt > 1) {
                        warnings.push(`Dados atualizados ap√≥s ${attempt} tentativas.`);
                    }
                    return { data, source: "network", attempts: attempt, warnings };
                } catch (error) {
                    lastError = error;
                    if (attempt < MAX_FETCH_RETRIES) {
                        await wait(RETRY_DELAY_BASE_MS * Math.pow(2, attempt - 1));
                    }
                }
            }

            if (cacheKey) {
                const cached = storage.get(cacheKey);
                if (cached) {
                    warnings.push(`Falha ao atualizar (${lastError?.message || "erro desconhecido"}). Utilizando dados do cache.`);
                    return { data: cached, source: "cache", attempts: attempt, warnings };
                }
            }

            throw lastError || new Error("Falha desconhecida ao buscar dados.");
        }

        async function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT_MS) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeout);
            try {
                return await fetch(url, { ...options, signal: controller.signal });
            } finally {
                clearTimeout(timer);
            }
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function sanitizeAbas(data) {
            if (!Array.isArray(data)) {
                reportWarning("Formato inesperado na resposta de abas.", typeof data);
                return [];
            }
            return data.reduce((lista, item, index) => {
                if (!item || typeof item !== "object") {
                    reportWarning("Item de aba ignorado por formato inv√°lido.", `posi√ß√£o ${index}`);
                    return lista;
                }
                const produtoOriginal = sanitizeString(item.produto);
                const abaOriginal = sanitizeString(item.aba);
                if (!produtoOriginal || !abaOriginal) {
                    reportWarning("Item de aba ignorado por campos vazios.", JSON.stringify(item));
                    return lista;
                }
                lista.push({
                    produtoOriginal,
                    grupoNormalizado: normalizeText(produtoOriginal),
                    produto: normalizeText(produtoOriginal),
                    abaOriginal,
                    aba: abaOriginal
                });
                return lista;
            }, []);
        }

        function sanitizeAudits(data, contexto) {
            if (!Array.isArray(data)) {
                reportWarning(`Formato inesperado de auditorias (${contexto.aba}/${contexto.produtoOriginal}).`, typeof data);
                return [];
            }

            return data.reduce((lista, item, index) => {
                if (!item || typeof item !== "object") {
                    reportWarning("Auditoria ignorada por formato inv√°lido.", `posi√ß√£o ${index}`);
                    return lista;
                }

                const audit = { ...item };
                audit.id = sanitizeAuditId(item, contexto, index);
                if (!audit.id) {
                    reportWarning("Auditoria descartada por aus√™ncia de identificador.", `${contexto.aba} - posi√ß√£o ${index}`);
                    return lista;
                }

                audit.produto = normalizeText(sanitizeString(item.produto) || contexto.produtoOriginal);
                audit.produto_interno = normalizeText(sanitizeString(item.produto_interno));
                audit.aba = sanitizeString(item.aba) || contexto.aba;
                audit.tecnico = sanitizeString(item.tecnico);
                audit.responsavel = sanitizeString(item.responsavel);
                audit.duracao = sanitizeString(item.duracao);
                audit.transferencia = sanitizeString(item.transferencia);
                audit.contato = sanitizeString(item.contato);
                audit.data_auditoria = sanitizeString(item.data_auditoria);
                audit.data_hora = sanitizeString(item.data_hora);
                audit.identificacao = sanitizeString(item.identificacao);
                audit.motivo = sanitizeString(item.motivo);
                audit.cliente_codigo = sanitizeString(item.cliente_codigo);

                PILARES_MAP.forEach(pilar => {
                    audit[pilar.id_nome] = sanitizeString(item[pilar.id_nome]);
                    audit[pilar.id_conf] = sanitizeString(item[pilar.id_conf]);
                    audit[pilar.id_obs] = sanitizeString(item[pilar.id_obs]);
                    audit[pilar.id_leg] = sanitizeString(item[pilar.id_leg]);
                });

                lista.push(audit);
                return lista;
            }, []);
        }

        function sanitizeAuditId(item, contexto, index) {
            const candidatos = [
                item.id,
                item.audit_id,
                item.identificacao,
                item.call_id,
                `${contexto.produtoOriginal}-${contexto.abaOriginal}-${item.data_auditoria || ""}-${index}`
            ];
            for (const candidato of candidatos) {
                const valor = sanitizeString(candidato);
                if (valor) return valor;
            }
            return null;
        }

        function deduplicateAbas(lista) {
            const mapa = new Map();
            lista.forEach(item => {
                const chave = `${item.produtoOriginal}::${item.abaOriginal}`;
                if (!mapa.has(chave)) {
                    mapa.set(chave, item);
                }
            });
            return Array.from(mapa.values());
        }

        function deduplicateAuditorias(lista) {
            const mapa = new Map();
            lista.forEach(audit => {
                const chave = `${audit.id}::${audit.aba || ""}::${audit.produto || ""}`;
                if (!mapa.has(chave)) {
                    mapa.set(chave, audit);
                    return;
                }
                const atual = mapa.get(chave);
                const dataAtual = parseAuditDate(atual.data_auditoria);
                const dataNova = parseAuditDate(audit.data_auditoria);
                if (dataNova && (!dataAtual || dataNova > dataAtual)) {
                    mapa.set(chave, audit);
                }
            });
            return Array.from(mapa.values());
        }

        function parseAuditDate(valor) {
            const str = sanitizeString(valor);
            if (!str) return null;
            if (str.includes("/")) {
                const partes = str.split(/[\/ ]/);
                if (partes.length >= 3) {
                    const [dia, mes, ano] = partes;
                    const iso = `${ano.padStart(4, "0")}-${mes.padStart(2, "0")}-${dia.padStart(2, "0")}T00:00:00`;
                    const date = new Date(iso);
                    if (!isNaN(date.getTime())) return date;
                }
            }
            const date = new Date(str);
            return isNaN(date.getTime()) ? null : date;
        }

        function sanitizeString(value) {
            if (value === null || value === undefined) return null;
            const str = `${value}`.trim();
            return str.length ? str : null;
        }

        function reportWarning(message, detail) {
            const texto = detail ? `${message} (${detail})` : message;
            diagnostics.warnings.push(texto);
            console.warn("[Dashboard]", message, detail || "");
        }

        // --- 6.1 FUN√á√ïES AUXILIARES (EXISTENTES) ---
        function normalizeText(str) {
            if (!str || typeof str !== 'string' || str.trim() === '') return null;
            return str.trim().toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }

        function parseDuration(valor) {
            if (valor === null || valor === undefined) return 0;
            if (typeof valor === "number" && !isNaN(valor)) return valor;

            const str = sanitizeString(valor);
            if (!str) return 0;

            if (/^\d+$/.test(str)) {
                return parseInt(str, 10);
            }

            if (str.includes(":")) {
                const partes = str.split(":").map(parte => parseInt(parte, 10));
                if (partes.every(num => !isNaN(num))) {
                    if (partes.length === 2) {
                        return partes[0] * 60 + partes[1];
                    }
                    if (partes.length === 3) {
                        return partes[0] * 3600 + partes[1] * 60 + partes[2];
                    }
                    if (partes.length === 4) {
                        return partes[0] * 86400 + partes[1] * 3600 + partes[2] * 60 + partes[3];
                    }
                }
            }

            const texto = str.toLowerCase();
            const match = texto.match(/(?:(\d+)\s*h)?\s*(?:(\d+)\s*m)?\s*(?:(\d+)\s*s)?/);
            if (match && (match[1] || match[2] || match[3])) {
                const horas = parseInt(match[1] || "0", 10);
                const minutos = parseInt(match[2] || "0", 10);
                const segundos = parseInt(match[3] || "0", 10);
                return horas * 3600 + minutos * 60 + segundos;
            }

            return 0;
        }

        function renderChart(canvasId, type, data, options) {
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            const ctx = $(canvasId).getContext('2d');
           chartInstances[canvasId] = new Chart(ctx, { type: type, data: data, options: options });
        }

        function destroyCharts() {
            Object.keys(chartInstances).forEach(id => {
                if (chartInstances[id]) {
                    chartInstances[id].destroy();
                   delete chartInstances[id];
                }
            });
        }


        // --- 6.2 NOVAS FUN√á√ïES DE GR√ÅFICO (MELHORIAS) ---

        /**
         * [NOVO - 1] Renderiza a evolu√ß√£o da conformidade ao longo do tempo (Gr√°fico de Linha)
         */
        function renderizarGraficoTendencia(audits) {
            const statsMensais = {}; // Ex: { "2023-10": { totalPilares: 0, conformes: 0 } }

            audits.forEach(audit => {
                if (!audit.data_auditoria) return; 
                
                let dataAudit;
                try {
                    // Tenta ajustar formato DD/MM/YYYY para YYYY-MM-DD (ISO)
                    if (audit.data_auditoria.includes('/')) {
                        const partes = audit.data_auditoria.split(' ')[0].split('/');
                        if (partes.length === 3 && partes[2].length === 4) {
                            // Assume formato DD/MM/YYYY
                            dataAudit = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
                        } else {
                            throw new Error('Formato de data inv√°lido');
                        }
                    } else {
                        dataAudit = new Date(audit.data_auditoria); // Assume formato ISO
                    }
                    if (isNaN(dataAudit.getTime())) throw new Error('Data inv√°lida');

                } catch (e) {
                    console.warn("Data de auditoria inv√°lida:", audit.data_auditoria, audit.id);
                    return; // Pula data inv√°lida
                }

                const mesKey = `${dataAudit.getFullYear()}-${String(dataAudit.getMonth() + 1).padStart(2, '0')}`;

                if (!statsMensais[mesKey]) {
                    statsMensais[mesKey] = { totalPilares: 0, conformes: 0 };
                }

                PILARES_MAP.forEach(pilar => {
                    const valorConf = audit[pilar.id_conf];
                    if (valorConf !== null) { 
                        statsMensais[mesKey].totalPilares++;
                        if (valorConf === VALOR_CONFORME) {
                            statsMensais[mesKey].conformes++;
                        }
                    }
                });
            });

            // Preparar dados para o Chart.js
            const labels = Object.keys(statsMensais).sort();
            const data = labels.map(key => {
                const stats = statsMensais[key];
                return (stats.totalPilares === 0) ? 0 : (stats.conformes / stats.totalPilares) * 100;
            });

            // Limitar aos √∫ltimos 12 meses para melhor visualiza√ß√£o
            const labelsFinais = labels.slice(-12);
            const dataFinal = data.slice(-12);
            
            // Renderizar o gr√°fico
            renderChart('chart-global-tendencia', 'line', {
                labels: labelsFinais,
                datasets: [{
                    label: 'Conformidade M√©dia (%)',
                    data: dataFinal,
                    borderColor: '#50e3c2',
                    backgroundColor: 'rgba(80, 227, 194, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            }, {
                responsive: true,
                scales: {
                    yAxes: [{ ticks: { beginAtZero: true, max: 100, fontColor: '#f0f0f0' }, gridLines: { color: '#444' } }],
                    xAxes: [{ ticks: { fontColor: '#f0f0f0' }, gridLines: { display: false } }]
                },
                legend: { labels: { fontColor: '#f0f0f0' }}
            });
        }


        /**
         * [NOVO - 2] Renderiza o ranking de agentes (Gr√°fico de Barras)
         */
        function renderizarGraficoRanking(audits, grupoSelecionado, abaSelecionada) {
            const container = $("charts-grid-ranking");

            // S√≥ mostra o ranking se estivermos na vis√£o de um GRUPO (mas n√£o de um funcion√°rio)
            if (grupoSelecionado === 'global' || abaSelecionada !== 'global') {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'grid'; // Mostra o container

            const statsFuncionarios = new Map(); // Map<string, { totalPilares: 0, conformes: 0 }>
            
            audits.forEach(audit => {
                const funcionario = audit.aba;
                if (!statsFuncionarios.has(funcionario)) {
                    statsFuncionarios.set(funcionario, { totalPilares: 0, conformes: 0 });
                }
                
                const stats = statsFuncionarios.get(funcionario);
                
                PILARES_MAP.forEach(pilar => {
                    const valorConf = audit[pilar.id_conf];
                    if (valorConf !== null) {
                        stats.totalPilares++;
                        if (valorConf === VALOR_CONFORME) {
                            stats.conformes++;
                        }
                    }
                });
            });

            // Formatar para o gr√°fico
            const rankingData = [];
            statsFuncionarios.forEach((stats, funcionario) => {
                const media = (stats.totalPilares === 0) ? 0 : (stats.conformes / stats.totalPilares) * 100;
                rankingData.push({ nome: funcionario, media: media });
            });

            // Ordenar por m√©dia (do maior para o menor)
            rankingData.sort((a, b) => b.media - a.media);

            const labels = rankingData.map(d => d.nome);
            const data = rankingData.map(d => d.media);

            renderChart('chart-global-ranking', 'horizontalBar', {
                labels: labels,
                datasets: [{
                    label: 'Conformidade M√©dia (%)',
                    data: data,
                    backgroundColor: '#8cb4e1'
                }]
            }, {
                responsive: true,
                legend: { display: false },
                scales: {
                    xAxes: [{ ticks: { beginAtZero: true, max: 100, fontColor: '#f0f0f0' }, gridLines: { color: '#444' } }],
                    yAxes: [{ ticks: { fontColor: '#f0f0f0' }, gridLines: { display: false } }]
                }
            });
        }


        /**
         * [NOVO - 3] Renderiza a correla√ß√£o entre Dura√ß√£o e Conformidade (Gr√°fico de Dispers√£o)
         */
        function renderizarGraficoCorrelacao(audits) {
            const container = $("charts-grid-correlacao");

            // N√£o mostrar se houver poucos dados para correlacionar
            if (audits.length < 5) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'grid';

            const scatterData = [];

            audits.forEach(audit => {
                const duracao = parseDuration(audit.duracao);
                if (duracao === 0) return; // Ignora auditorias sem dura√ß√£o

                let totalPilares = 0;
                let conformes = 0;
                
                PILARES_MAP.forEach(pilar => {
                    const valorConf = audit[pilar.id_conf];
                    if (valorConf !== null) {
                        totalPilares++;
                        if (valorConf === VALOR_CONFORME) {
                            conformes++;
                        }
                    }
                });

                const conformidade = (totalPilares === 0) ? 0 : (conformes / totalPilares) * 100;
                
                scatterData.push({ x: duracao, y: conformidade });
            });

            renderChart('chart-global-correlacao', 'scatter', {
                datasets: [{
                    label: 'Auditoria',
                    data: scatterData,
                    backgroundColor: 'rgba(74, 144, 226, 0.7)'
                }]
            }, {
                responsive: true,
                legend: { display: false },
                scales: {
                    xAxes: [{
                        type: 'linear',
                        position: 'bottom',
                        ticks: { fontColor: '#f0f0f0' },
                        gridLines: { color: '#444' },
                        scaleLabel: {
                            display: true,
                            labelString: 'Dura√ß√£o (segundos)',
                            fontColor: '#bbb'
                        }
                    }],
                    yAxes: [{
                        ticks: { beginAtZero: true, max: 100, fontColor: '#f0f0f0' },
                        gridLines: { color: '#444' },
                         scaleLabel: {
                            display: true,
                            labelString: 'Conformidade (%)',
                            fontColor: '#bbb'
                        }
                    }]
                }
            });
        }


        // --- 7. INICIALIZA√á√ÉO ---
        window.onload = carregarTudo;

    </script>
</body>
</html>